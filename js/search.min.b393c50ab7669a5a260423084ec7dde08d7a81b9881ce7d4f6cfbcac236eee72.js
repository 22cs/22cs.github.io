document.addEventListener("DOMContentLoaded",function(){let t,n={},o=null;const s=document.getElementById("search-input"),e=document.getElementById("search-results");function a(){return fetch("/index.json").then(e=>e.json()).then(e=>{t=e.data,o=e.version,console.log("Search index loaded:",t.length+" articles, Version:",o)}).catch(t=>{console.error("Failed to load search index:",t),e.innerHTML='<div class="search-message">Failed to load search index. Please refresh the page.</div>'})}a();function d(e,t){const o=t.toLowerCase();if(n[o])return n[o];t=t.toLowerCase();const s=t.split(/\s+/).filter(e=>e.length>=2),i=e.map(e=>{let n=0;const o=e.title.toLowerCase(),i=e.content.toLowerCase();if(o===t?n+=100:o.includes(t)&&(n+=50),i.includes(t)&&(n+=30),e.tags&&e.tags.some(e=>e.toLowerCase().includes(t))&&(n+=20),e.categories&&e.categories.some(e=>e.toLowerCase().includes(t))&&(n+=20),s.length>1){const e=s.filter(e=>o.includes(e)||i.includes(e)).length;n+=e/s.length*25}for(const e of s.length>1?s:[t]){if(e.length<2)continue;for(let t=0;t<=o.length-e.length;t++){const s=o.slice(t,t+e.length),i=u(s,e);if(i<=2){n+=(1-i/Math.max(s.length,e.length))*10;break}}i.includes(e)&&(n+=5)}return{item:e,score:n}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score);return n[o]=i,i}function u(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;let n=Array(t.length+1).fill(0),s=Array(t.length+1).fill(0);for(let e=0;e<=t.length;e++)n[e]=e;for(let o=0;o<e.length;o++){s[0]=o+1;for(let i=0;i<t.length;i++){const a=e[o]===t[i]?0:1;s[i+1]=Math.min(s[i]+1,n[i+1]+1,n[i]+a)}[n,s]=[s,n]}return n[t.length]}function r(s){if(!t){e.innerHTML='<div class="search-message">Search index is loading, please wait...</div>';return}if(s.trim()===""){e.innerHTML='<div class="search-message">Please enter search keywords</div>';return}fetch("/index.json").then(e=>e.json()).then(e=>{e.version!==o?a().then(()=>{n={},i(s)}):i(s)}).catch(e=>{console.error("Failed to check index version:",e),i(s)})}function i(n){const i=performance.now(),s=d(t,n),a=performance.now();if(s.length===0){e.innerHTML='<div class="search-message">No matching results found</div>';return}const r=((a-i)/1e3).toFixed(3);let o=`<div class="search-summary">Found ${s.length} results (${r} seconds)</div>`;s.forEach(({item:e,score:t})=>{let s="";const a=n.toLowerCase(),r=e.content.toLowerCase(),i=r.indexOf(a);if(i!==-1){const t=Math.max(0,i-60),o=Math.min(e.content.length,i+n.length+100);s=e.content.substring(t,o),t>0&&(s="..."+s),o<e.content.length&&(s+="...")}else s=e.content.substring(0,200)+"...";o+=`
                <div class="search-result-item">
                    <h3 class="search-result-title">
                        <a href="${e.permalink}">${c(e.title,n)}</a>
                    </h3>
                    <div class="search-result-meta">
                        <time>${e.date}</time>
                        ${e.categories&&e.categories.length?" • "+e.categories.map(e=>`<a href="/categories/${encodeURIComponent(e.toLowerCase())}">${e}</a>`).join(", "):""}
                        ${e.tags&&e.tags.length?" • "+e.tags.map(e=>`<a href="/tags/${encodeURIComponent(e.toLowerCase())}">#${e}</a>`).join(" "):""}
                    </div>
                    <div class="search-result-snippet">${c(s,n)}</div>
                </div>
            `}),e.innerHTML=o}function c(e,t){const s=t.split(/\s+/).filter(e=>e.length>1);let n=e;if(s.length>1)return s.forEach(e=>{const t=new RegExp(l(e),"gi");n=n.replace(t,e=>`<span class="search-highlight">${e}</span>`)}),n;const o=new RegExp(l(t),"gi");return n.replace(o,e=>`<span class="search-highlight">${e}</span>`)}function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}if(s){let t;s.addEventListener("input",function(){clearTimeout(t),t=setTimeout(()=>{r(this.value)},300)}),s.addEventListener("keydown",function(e){e.key==="Enter"&&(r(this.value),e.preventDefault())}),s.addEventListener("change",function(){this.value===""&&(e.innerHTML='<div class="search-message">Please enter search keywords</div>')})}})