document.addEventListener("DOMContentLoaded",function(){let e;const t=document.getElementById("search-input"),n=document.getElementById("search-results");fetch("/index.json").then(e=>e.json()).then(t=>{e=t,console.log("搜索索引加载完成",e.length+"篇文章")}).catch(e=>{console.error("加载搜索索引失败:",e)});function o(e,t){return t=t.toLowerCase(),e.map(e=>{let n=0;const s=e.title.toLowerCase();s===t?n+=100:s.includes(t)&&(n+=50);const a=e.content.toLowerCase();a.includes(t)&&(n+=30),e.tags&&e.tags.some(e=>e.toLowerCase().includes(t))&&(n+=20),e.categories&&e.categories.some(e=>e.toLowerCase().includes(t))&&(n+=20);const o=t.split(/\s+/);if(o.length>1){const e=o.filter(e=>s.includes(e)||a.includes(e)).length;n+=e/o.length*25}for(const e of o.length>1?o:[t]){if(e.length<2)continue;for(let t=0;t<=s.length-e.length;t++){const o=s.slice(t,t+e.length),a=i(o,e);if(a<=2){n+=(1-a/Math.max(o.length,e.length))*10;break}}a.includes(e)&&(n+=5)}return{item:e,score:n}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score)}function i(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;const n=[];for(let e=0;e<=t.length;e++)n[e]=[e];for(let t=0;t<=e.length;t++)n[0][t]=t;for(let s=1;s<=t.length;s++)for(let o=1;o<=e.length;o++)t.charAt(s-1)===e.charAt(o-1)?n[s][o]=n[s-1][o-1]:n[s][o]=Math.min(n[s-1][o-1]+1,n[s][o-1]+1,n[s-1][o]+1);return n[t.length][e.length]}function s(t){if(!e||t.trim()===""){n.innerHTML='<div class="search-message">请输入搜索关键词</div>';return}const a=performance.now(),s=o(e,t),r=performance.now();if(s.length===0){n.innerHTML='<div class="search-message">没有找到匹配的结果</div>';return}const c=((r-a)/1e3).toFixed(3);let i=`<div class="search-summary">找到 ${s.length} 个结果 (${c} 秒)</div>`;s.forEach(({item:e,score:n})=>{let s="";const r=t.toLowerCase(),c=e.content.toLowerCase(),o=c.indexOf(r);if(o!==-1){const n=Math.max(0,o-60),i=Math.min(e.content.length,o+t.length+100);s=e.content.substring(n,i),n>0&&(s="..."+s),i<e.content.length&&(s=s+"...")}else s=e.content.substring(0,200)+"...";function a(e,t){const n=t.split(/\s+/).filter(e=>e.length>1);if(n.length>1){let t=e;return n.forEach(e=>{const n=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");t=t.replace(n,e=>`<span class="search-highlight">${e}</span>`)}),t}const s=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");return e.replace(s,e=>`<span class="search-highlight">${e}</span>`)}i+=`
                <div class="search-result-item">
                    <h3 class="search-result-title">
                        <a href="${e.permalink}">${a(e.title,t)}</a>
                    </h3>
                    <div class="search-result-meta">
                        <time>${e.date}</time>
                        ${e.categories&&e.categories.length?" • "+e.categories.map(e=>`<a href="/categories/${encodeURIComponent(e.toLowerCase())}">${e}</a>`).join(", "):""}
                        ${e.tags&&e.tags.length?" • "+e.tags.map(e=>`<a href="/tags/${encodeURIComponent(e.toLowerCase())}">#${e}</a>`).join(" "):""}
                    </div>
                    <div class="search-result-snippet">${a(s,t)}</div>
                </div>
            `}),n.innerHTML=i}if(t){let e;t.addEventListener("input",function(){clearTimeout(e),e=setTimeout(()=>{s(this.value)},300)}),t.addEventListener("keydown",function(e){e.key==="Enter"&&(s(this.value),e.preventDefault())}),t.addEventListener("change",function(){this.value===""&&(n.innerHTML="")})}})