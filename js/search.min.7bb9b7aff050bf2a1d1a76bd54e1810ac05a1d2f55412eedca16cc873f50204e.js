document.addEventListener("DOMContentLoaded",function(){let t,s={};const n=document.getElementById("search-input"),e=document.getElementById("search-results");fetch("/index.json").then(e=>e.json()).then(e=>{t=e,console.log("搜索索引加载完成",t.length+"篇文章")}).catch(t=>{console.error("加载搜索索引失败:",t),e.innerHTML='<div class="search-message">加载搜索索引失败，请刷新页面重试</div>'});function r(e,t){const o=t.toLowerCase();if(s[o])return s[o];t=t.toLowerCase();const n=t.split(/\s+/).filter(e=>e.length>=2),i=e.map(e=>{let s=0;const o=e.title.toLowerCase();o===t?s+=100:o.includes(t)&&(s+=50);const i=e.content.toLowerCase();if(i.includes(t)&&(s+=30),e.tags&&e.tags.some(e=>e.toLowerCase().includes(t))&&(s+=20),e.categories&&e.categories.some(e=>e.toLowerCase().includes(t))&&(s+=20),n.length>1){const e=n.filter(e=>o.includes(e)||i.includes(e)).length;s+=e/n.length*25}for(const e of n.length>1?n:[t]){if(e.length<2)continue;for(let t=0;t<=o.length-e.length;t++){const n=o.slice(t,t+e.length),i=c(n,e);if(i<=2){s+=(1-i/Math.max(n.length,e.length))*10;break}}i.includes(e)&&(s+=5)}return{item:e,score:s}}).filter(e=>e.score>0).sort((e,t)=>t.score-e.score);return s[o]=i,i}function c(e,t){if(e.length===0)return t.length;if(t.length===0)return e.length;let n=Array(t.length+1).fill(0),s=Array(t.length+1).fill(0);for(let e=0;e<=t.length;e++)n[e]=e;for(let o=0;o<e.length;o++){s[0]=o+1;for(let i=0;i<t.length;i++){const a=e[o]===t[i]?0:1;s[i+1]=Math.min(s[i]+1,n[i+1]+1,n[i]+a)}[n,s]=[s,n]}return n[t.length]}function o(n){if(!t){e.innerHTML='<div class="search-message">搜索索引正在加载中，请稍后再试</div>';return}if(n.trim()===""){e.innerHTML='<div class="search-message">请输入搜索关键词</div>';return}const a=performance.now(),s=r(t,n),c=performance.now();if(s.length===0){e.innerHTML='<div class="search-message">没有找到匹配的结果</div>';return}const l=((c-a)/1e3).toFixed(3);let o=`<div class="search-summary">找到 ${s.length} 个结果 (${l} 秒)</div>`;s.forEach(({item:e,score:t})=>{let s="";const r=n.toLowerCase(),c=e.content.toLowerCase(),a=c.indexOf(r);if(a!==-1){const t=Math.max(0,a-60),o=Math.min(e.content.length,a+n.length+100);s=e.content.substring(t,o),t>0&&(s="..."+s),o<e.content.length&&(s=s+"...")}else s=e.content.substring(0,200)+"...";o+=`
                <div class="search-result-item">
                    <h3 class="search-result-title">
                        <a href="${e.permalink}">${i(e.title,n)}</a>
                    </h3>
                    <div class="search-result-meta">
                        <time>${e.date}</time>
                        ${e.categories&&e.categories.length?" • "+e.categories.map(e=>`<a href="/categories/${encodeURIComponent(e.toLowerCase())}">${e}</a>`).join(", "):""}
                        ${e.tags&&e.tags.length?" • "+e.tags.map(e=>`<a href="/tags/${encodeURIComponent(e.toLowerCase())}">#${e}</a>`).join(" "):""}
                    </div>
                    <div class="search-result-snippet">${i(s,n)}</div>
                </div>
            `}),e.innerHTML=o}function i(e,t){const n=t.split(/\s+/).filter(e=>e.length>1);if(n.length>1){let t=e;return n.forEach(e=>{const n=new RegExp(a(e),"gi");t=t.replace(n,e=>`<span class="search-highlight">${e}</span>`)}),t}const s=new RegExp(a(t),"gi");return e.replace(s,e=>`<span class="search-highlight">${e}</span>`)}function a(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}if(n){let t;n.addEventListener("input",function(){clearTimeout(t),t=setTimeout(()=>{o(this.value)},300)}),n.addEventListener("keydown",function(e){e.key==="Enter"&&(o(this.value),e.preventDefault())}),n.addEventListener("change",function(){this.value===""&&(e.innerHTML='<div class="search-message">请输入搜索关键词</div>')})}})